# DeDox - Docker Compose
# Complete stack with all required services

services:
  # DeDox API Service
  dedox:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dedox
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - ./config:/app/config:ro
    environment:
      - DEDOX_CONFIG_DIR=/app/config
      - DEDOX_JWT_SECRET=${DEDOX_JWT_SECRET:-change-me-in-production}
      # DeDox admin user (auto-created on first startup)
      - DEDOX_ADMIN_EMAIL=${DEDOX_ADMIN_EMAIL:-admin@example.com}
      - DEDOX_ADMIN_PASSWORD=${DEDOX_ADMIN_PASSWORD:-changeme123}
      - DEDOX_PAPERLESS_URL=http://paperless:8000
      - DEDOX_PAPERLESS_TOKEN=${DEDOX_PAPERLESS_TOKEN:-}
      - DEDOX_OLLAMA_URL=http://ollama:11434
      # LLM model to use
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3-vl:8b}
      # Paperless admin credentials for auto token generation
      - PAPERLESS_ADMIN_USER=${PAPERLESS_ADMIN_USER:-admin}
      - PAPERLESS_ADMIN_PASSWORD=${PAPERLESS_ADMIN_PASSWORD:-admin}
      # Open WebUI credentials for auto API key generation
      - DEDOX_OPENWEBUI_API_KEY=${DEDOX_OPENWEBUI_API_KEY:-}
      - OPENWEBUI_ADMIN_EMAIL=${OPENWEBUI_ADMIN_EMAIL:-admin@example.com}
      - OPENWEBUI_ADMIN_PASSWORD=${OPENWEBUI_ADMIN_PASSWORD:-admin}
    depends_on:
      ollama:
        condition: service_healthy
      paperless:
        condition: service_healthy
      open-webui:
        condition: service_healthy
    networks:
      - dedox-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # DeDox Background Worker
  dedox-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dedox-worker
    restart: unless-stopped
    command: ["python", "-m", "dedox.services.job_worker"]
    volumes:
      - ./data:/app/data
      - ./config:/app/config:ro
    environment:
      - DEDOX_CONFIG_DIR=/app/config
      - DEDOX_JWT_SECRET=${DEDOX_JWT_SECRET:-change-me-in-production}
      - DEDOX_PAPERLESS_URL=http://paperless:8000
      - DEDOX_PAPERLESS_TOKEN=${DEDOX_PAPERLESS_TOKEN:-}
      - DEDOX_OLLAMA_URL=http://ollama:11434
      # LLM model to use
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3-vl:8b}
      # Paperless admin credentials for auto token generation
      - PAPERLESS_ADMIN_USER=${PAPERLESS_ADMIN_USER:-admin}
      - PAPERLESS_ADMIN_PASSWORD=${PAPERLESS_ADMIN_PASSWORD:-admin}
      # Open WebUI credentials for auto API key generation
      - DEDOX_OPENWEBUI_API_KEY=${DEDOX_OPENWEBUI_API_KEY:-}
      - OPENWEBUI_ADMIN_EMAIL=${OPENWEBUI_ADMIN_EMAIL:-admin@example.com}
      - OPENWEBUI_ADMIN_PASSWORD=${OPENWEBUI_ADMIN_PASSWORD:-admin}
    depends_on:
      - dedox
      - ollama
      - paperless
    networks:
      - dedox-network

  # Ollama - Local LLM Server
  ollama:
    image: ollama/ollama:latest
    container_name: dedox-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - dedox-network
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Ollama Model Loader (one-shot to pull the model)
  ollama-pull:
    image: ollama/ollama:latest
    container_name: dedox-ollama-pull
    depends_on:
      ollama:
        condition: service_healthy
    entrypoint: ["sh", "-c", "ollama pull ${OLLAMA_MODEL:-qwen3-vl:8b}"]
    environment:
      - OLLAMA_HOST=http://ollama:11434
    networks:
      - dedox-network
    restart: "no"

  # Paperless-ngx (optional - can use external instance)
  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: dedox-paperless
    restart: unless-stopped
    ports:
      - "8080:8000"
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-export:/usr/src/paperless/export
      - paperless-consume:/usr/src/paperless/consume
    environment:
      - PAPERLESS_REDIS=redis://redis:6379
      - PAPERLESS_DBHOST=postgres
      - PAPERLESS_DBNAME=paperless
      - PAPERLESS_DBUSER=paperless
      - PAPERLESS_DBPASS=${POSTGRES_PASSWORD:-paperless}
      - PAPERLESS_SECRET_KEY=${PAPERLESS_SECRET_KEY:-change-me}
      - PAPERLESS_ADMIN_USER=admin
      - PAPERLESS_ADMIN_PASSWORD=${PAPERLESS_ADMIN_PASSWORD:-admin}
      - PAPERLESS_URL=http://localhost:8080
      - PAPERLESS_OCR_LANGUAGE=deu+eng
      - PAPERLESS_OCR_MODE=skip
    depends_on:
      - postgres
      - redis
    networks:
      - dedox-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL for Paperless
  postgres:
    image: postgres:15-alpine
    container_name: dedox-postgres
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=paperless
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-paperless}
    networks:
      - dedox-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U paperless -d paperless"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Paperless
  redis:
    image: redis:7-alpine
    container_name: dedox-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - dedox-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Open WebUI - Document RAG and Chat Interface
  open-webui:
    image: ghcr.io/open-webui/open-webui:cuda
    container_name: dedox-openwebui
    restart: unless-stopped
    ports:
      - "${OPENWEBUI_PORT:-3000}:8080"
    volumes:
      - openwebui-data:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - WEBUI_SECRET_KEY=${OPENWEBUI_SECRET_KEY:-change-me-in-production}
      # Auto-create admin user on first startup
      - WEBUI_ADMIN_NAME=Admin
      - WEBUI_ADMIN_EMAIL=${OPENWEBUI_ADMIN_EMAIL:-admin@example.com}
      - WEBUI_ADMIN_PASSWORD=${OPENWEBUI_ADMIN_PASSWORD:-admin}
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - dedox-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  dedox-network:
    driver: bridge

volumes:
  ollama-data:
  paperless-data:
  paperless-media:
  paperless-export:
  paperless-consume:
  postgres-data:
  redis-data:
  openwebui-data:
